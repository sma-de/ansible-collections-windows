---

## winservice_nssm_args:
##   nssm: ## optional, empty default
##   service: ## mandatory
##     create: ## mandatory
##       name:
##       application:
##       arguments:
##       working_directory:
##       description:
##       display_name:
##     config: ## optional

  - set_fact:
      _tmp_targs: >-
         {{ { 'name': 'nssm', 'state': 'latest' } 
          | combine(winservice_nssm_args.nssm | default({}, True)) }}

  - name: ensure nssm is avaible
    win_chocolatey: "{{ _tmp_targs }}"


  - name: >-
      create win service wrapper ==> {{ winservice_nssm_args.service.create.name }}

    win_nssm: "{{ winservice_nssm_args.service.create }}"

    # TODO: win_nssm does not set changed_when correctly atm, in this case it seems better to report the few changed cases as green instead of the many green cases as changed, if this is someday fixed in ansible, remove this workaround
    changed_when: false


  - set_fact:
      _tmp_targs: >-
         {{ { 'name': winservice_nssm_args.service.create.name, 'state': 'started', 'start_mode': 'auto' } 
          | combine(winservice_nssm_args.service.config | default({}, True)) }}

  - name: >-
      configure new win service ==> {{ winservice_nssm_args.service.create.name }}
    win_service: "{{ _tmp_targs }}"

