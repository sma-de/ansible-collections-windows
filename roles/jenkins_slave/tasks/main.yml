---

##jenkins_slave_args:
##  disable_winssh: true ## optional, defaults to false
##  enable_default_java: true ## optional, defaults to false
##  default_java_extra_args: ## optional, defaults to empty
##    version: '8.232.9'

  - import_role:
      name: smabot.windows.win_capability
    vars:
      win_capability_args:
        ## note: the reason for this is, that it clashes with jenkins ssh agent: https://issues.jenkins-ci.org/browse/JENKINS-51968
        task_name: make sure that windows builtin experimental ssh client is disabled as it currently breaks jenkins
        cap_args: 
          caps: .*openssh.*
          state: absent
    when: jenkins_slave_args.disable_winssh | default(False, True)


    ## default java deselected
  - block:

      - name: check if java is installed
        smabot.windows.command_info:
          command: java
          type: Application
        register: _res_find_java

      - ansible.builtin.assert:
          that: >-
            ansible_env.JAVA_HOME is defined or
            _res_find_java.command_info.get('java.exe', False) is truthy
          fail_msg: >-
            windows jenkins slave needs java installed on target machine, 
            either make sure it is installed before calling this role or 
            enable default java installation by setting 
            jenkins_slave_args.enable_default_java to true

    when: not (jenkins_slave_args.enable_default_java | default(False, True))


    ## default java selected
  - block:

      - set_fact:
          _tmp_java_inst_args: >-
            {{ { 'name': 'adoptopenjdk8jre', 'state': 'present' } 
             | combine(jenkins_slave_args.default_java_extra_args | default({}, True)) }}

      - name: install default java runtime for jenkins
        chocolatey.chocolatey.win_chocolatey: "{{ _tmp_java_inst_args }}"

    when: jenkins_slave_args.enable_default_java | default(False, True)

